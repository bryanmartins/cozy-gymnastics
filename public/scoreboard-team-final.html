<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scoreboard Final por Equipes | Jogos Olímpicos Brussels 2025</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lipis/flag-icons@7.0.0/css/flag-icons.min.css"/>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: #1e3c72;
        }

        /* Header olímpico */
        .olympic-header {
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            color: white;
            padding: 1rem 0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .competition-info {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border-left: 5px solid #0066cc;
        }

        .qualification-summary {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin: 2rem 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border-left: 5px solid #ffd700;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .summary-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .summary-card:hover {
            transform: translateY(-5px);
        }

        .summary-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-weight: bold;
            color: #0066cc;
            font-size: 1.1rem;
        }

        .summary-icon {
            width: 24px;
            height: 24px;
            color: #ffd700;
        }

        .medal-results {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .medal-position {
            text-align: center;
            padding: 1rem;
            border-radius: 8px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .medal-position.gold {
            border-left: 4px solid #ffd700;
        }

        .medal-position.silver {
            border-left: 4px solid #c0c0c0;
        }

        .medal-position.bronze {
            border-left: 4px solid #cd7f32;
        }

        .medal-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .medal-country {
            font-weight: bold;
            color: #0066cc;
            margin-bottom: 0.3rem;
        }

        .medal-score {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
        }

        .country-flag {
            margin-right: 0.5rem;
        }

        /* Conteúdo principal */
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
        }

        /* Botões de navegação */
        .back-btn, .nav-btn {
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            color: white;
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 10px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .back-btn:hover, .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        /* Anéis olímpicos */
        .olympic-rings {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .ring {
            width: 30px;
            height: 30px;
            border: 3px solid;
            border-radius: 50%;
        }

        .ring.blue { border-color: #0085c3; }
        .ring.yellow { border-color: #ffb81c; }
        .ring.black { border-color: #000000; }
        .ring.green { border-color: #009f3d; }
        .ring.red { border-color: #df0024; }

        .apparatus-value {
            font-size: 1rem;
            font-weight: bold;
            color: #0066cc;
        }

        .team-gymnasts {
            margin-top: 1rem;
            font-size: 0.9rem;
            color: #666;
        }

        .full-results {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-top: 2rem;
        }

        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .results-table th {
            background: linear-gradient(135deg, #0066cc, #004499);
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: bold;
        }

        .results-table td {
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }

        .results-table tr:hover {
            background: #f8f9fa;
        }

        .rank {
            font-weight: bold;
            font-size: 1.2rem;
            color: #0066cc;
            text-align: center;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #666;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0066cc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .back-btn {
            background: linear-gradient(135deg, #6c757d, #5a6268);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 2rem;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(108,117,125,0.3);
            text-decoration: none;
            color: white;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: 1rem;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(23,162,184,0.3);
        }

        @media (max-width: 768px) {
            .podium {
                grid-template-columns: 1fr;
            }

            .olympic-rings {
                display: flex;
                gap: 3px;
            }

            .ring {
                width: 20px;
                height: 20px;
                border-width: 2px;
            }

            .results-table {
                font-size: 0.9rem;
            }

            .apparatus-scores {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="olympic-header">
        <div class="container">
            <div class="olympic-rings">
                <div class="ring blue"></div>
                <div class="ring yellow"></div>
                <div class="ring black"></div>
                <div class="ring green"></div>
                <div class="ring red"></div>
            </div>
            <h1><i class="fas fa-users"></i> Brussels 2025 - Final por Equipes</h1>
            <p>Resultados da Final por Equipes</p>
        </div>
    </div>

    <div class="main-content">
        <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 2rem;">
            <a href="dashboard.html" class="back-btn">
                <i class="fas fa-arrow-left"></i> Voltar ao Dashboard
            </a>
            <button class="refresh-btn" onclick="loadResults()">
                <i class="fas fa-sync-alt"></i> Atualizar Resultados
            </button>
        </div>

        <div class="competition-info">
            <h2><i class="fas fa-info-circle"></i> Informações da Competição</h2>
            <p><strong>Modalidade:</strong> Final por Equipes</p>
            <p><strong>Formato:</strong> 8 equipes qualificadas, 3 ginastas por aparelho, contam as 3 melhores notas</p>
            <p><strong>Qualificação:</strong> Melhores 8 equipes das Qualificatórias</p>
        </div>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Carregando resultados...</p>
        </div>

        <div id="teamResults" style="display: none;">
            <div class="qualification-summary">
                <h2><i class="fas fa-trophy"></i> Resumo da Final por Equipes</h2>
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="summary-header">
                            <i class="fas fa-medal summary-icon"></i>
                            Pódio por Equipes
                        </div>
                        <div class="medal-results" id="podiumSummary">
                            <!-- Pódio será preenchido via JavaScript -->
                        </div>
                    </div>
                    
                    <div class="summary-card">
                        <div class="summary-header">
                            <i class="fas fa-chart-line summary-icon"></i>
                            Estatísticas
                        </div>
                        <div id="statsContent">
                            <!-- Estatísticas serão preenchidas via JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="fullResults" class="full-results" style="display: none;">
            <h2><i class="fas fa-list"></i> Classificação Completa por Equipes</h2>
            <div style="overflow-x: auto;">
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Pos</th>
                            <th>Equipe</th>
                            <th>VT</th>
                            <th>UB</th>
                            <th>BB</th>
                            <th>FX</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="resultsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="js/countries.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="js/firebase-init.js"></script>
    <script src="js/calculation-logic.js"></script>

    <script>
        // Firebase já inicializado via firebase-init.js (globals)
        const db = window.db;
        
        let unsubscribe = null;

        // Carregar resultados com sincronização em tempo real
        function loadResults() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('teamResults').style.display = 'none';
                document.getElementById('fullResults').style.display = 'none';

                console.log('[SCOREBOARD] Carregando dados para Final por Equipes...');
                
                // Fechar listener anterior se existir
                if (unsubscribe) {
                    unsubscribe();
                }

                let allGymnastData = [];
                let teamFinalDrawData = null;

                // Carregar dados das ginastas
                const unsubscribeGymnasts = window.db.collection('new_gymnasts').onSnapshot((snapshot) => {
                    allGymnastData = [];
                    
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        if (data.name && data.country) {
                            allGymnastData.push({
                                id: doc.id,
                                ...data
                            });
                        }
                    });
                    
                    console.log('[SCOREBOARD] Dados das ginastas atualizados');
                    
                    // Log de amostra das ginastas para debug
                    const sampleGymnasts = allGymnastData.slice(0, 5);
                    sampleGymnasts.forEach(g => {
                        console.log(`[SCOREBOARD-DATA] ${g.name}:`, {
                            id: g.id,
                            team_final_present: g.team_final_present,
                            team_final_scores: g.scores?.team_final || 'NO SCORES'
                        });
                    });
                    
                    // Recalcular resultados quando dados mudarem
                    if (allGymnastData.length > 0) {
                        calculateAndDisplayResults();
                    }
                }, (error) => {
                    console.error('[SCOREBOARD] Erro ao carregar ginastas:', error);
                });

                // Carregar dados de duplicação da Final por Equipes
                const unsubscribeDraw = window.db.collection('start_lists').doc('team_final').onSnapshot((doc) => {
                    if (doc.exists) {
                        teamFinalDrawData = doc.data();
                        console.log('[SCOREBOARD] Documento team_final carregado:', teamFinalDrawData);
                        console.log('[SCOREBOARD] Tem duplicações?', !!teamFinalDrawData.duplications);
                        console.log('[SCOREBOARD] Dados de sorteio atualizados:', teamFinalDrawData ? 'com duplicações' : 'formato antigo');
                        
                        // Recalcular resultados quando sorteio mudar
                        if (allGymnastData.length > 0) {
                            calculateAndDisplayResults();
                        }
                    } else {
                        console.log('[SCOREBOARD] Documento team_final não existe');
                    }
                }, (error) => {
                    console.error('[SCOREBOARD] Erro ao carregar sorteio:', error);
                });

                function calculateAndDisplayResults() {
                    try {
                        console.log('[SCOREBOARD] Calculando resultados...');
                        
                        // Determinar países qualificados (top 8)
                        const teamQualifiers = calculateTeamScores(allGymnastData).slice(0, 8);
                        const qualifyingCountries = teamQualifiers.map(t => t.country);
                        
                        console.log('[SCOREBOARD] Países qualificados:', qualifyingCountries);

                        let teamFinalResults;
                        
                        // Tentar usar função com duplicação se disponível
                        if (teamFinalDrawData && teamFinalDrawData.duplications) {
                            console.log('[SCOREBOARD] Usando cálculo com duplicações do documento oficial');
                            teamFinalResults = calculateTeamFinalScoresWithDuplication(
                                allGymnastData, 
                                qualifyingCountries, 
                                teamFinalDrawData
                            );
                        } else {
                            console.log('[SCOREBOARD] Sem documento de duplicações - usando cálculo tradicional');
                            teamFinalResults = calculateTeamFinalScores(allGymnastData, qualifyingCountries);
                        }

                        console.log('[SCOREBOARD] Resultados calculados:', teamFinalResults);

                        // Converter para formato esperado pelo display
                        const results = teamFinalResults.map(team => ({
                            country: team.country,
                            scores: {
                                VT: team.vt,
                                UB: team.ub,
                                BB: team.bb,
                                FX: team.fx
                            },
                            total: team.total,
                            gymnasts: allGymnastData
                                .filter(g => g.country === team.country)
                                .map(g => g.name)
                        }));

                        displayResults(results);

                    } catch (error) {
                        console.error('[SCOREBOARD] Erro ao calcular resultados:', error);
                        document.getElementById('loading').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Erro ao calcular resultados';
                    }
                }

                // Salvar unsubscribes para cleanup
                unsubscribe = () => {
                    unsubscribeGymnasts();
                    unsubscribeDraw();
                };
                
            } catch (error) {
                console.error('[SCOREBOARD] Erro ao inicializar:', error);
                document.getElementById('loading').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Erro ao carregar dados';
            }
        }

        function displayResults(results) {
            displayTeamSummary(results);
            displayFullResults(results);
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('teamResults').style.display = 'block';
            document.getElementById('fullResults').style.display = 'block';
        }

        function displayTeamSummary(results) {
            // Pódio
            const podiumContainer = document.getElementById('podiumSummary');
            podiumContainer.innerHTML = '';

            const topThree = results.slice(0, 3);
            const medals = ['🥇', '🥈', '🥉'];
            const medalClasses = ['gold', 'silver', 'bronze'];

            topThree.forEach((team, index) => {
                const medalDiv = document.createElement('div');
                medalDiv.className = `medal-position ${medalClasses[index]}`;
                medalDiv.innerHTML = `
                    <div class="medal-icon">${medals[index]}</div>
                    <div class="medal-country">
                        <span class="fi fi-${getCountryCode(team.country)} country-flag"></span>
                        ${team.country}
                    </div>
                    <div class="medal-score">${team.total.toFixed(3)}</div>
                `;
                podiumContainer.appendChild(medalDiv);
            });

            // Estatísticas
            const statsContainer = document.getElementById('statsContent');
            let totalTeams = results.length;
            let highestScore = results[0]?.total || 0;
            let averageScore = results.reduce((sum, team) => sum + team.total, 0) / results.length;

            statsContainer.innerHTML = `
                <div style="margin-bottom: 1rem;">
                    <strong>Equipes participantes:</strong> ${totalTeams}
                </div>
                <div style="margin-bottom: 1rem;">
                    <strong>Maior pontuação:</strong> ${highestScore.toFixed(3)}
                </div>
                <div style="margin-bottom: 1rem;">
                    <strong>Média geral:</strong> ${averageScore.toFixed(3)}
                </div>
                <div>
                    <strong>Formato:</strong> 3-up, 3-count
                </div>
            `;
        }

        function displayFullResults(results) {
            const tbody = document.getElementById('resultsTableBody');
            tbody.innerHTML = '';

            results.forEach((team, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="rank">${index + 1}</td>
                    <td>
                        <span class="fi fi-${getCountryCode(team.country)} country-flag"></span>
                        <strong>${team.country}</strong>
                        <br><small style="color: #666;">${team.gymnasts.join(', ')}</small>
                    </td>
                    <td>${team.scores.VT.toFixed(3)}</td>
                    <td>${team.scores.UB.toFixed(3)}</td>
                    <td>${team.scores.BB.toFixed(3)}</td>
                    <td>${team.scores.FX.toFixed(3)}</td>
                    <td><strong>${team.total.toFixed(3)}</strong></td>
                `;
                tbody.appendChild(row);
            });
        }

        function getCountryCode(country) {
            const codes = {
                'Brasil': 'br',
                'Brazil': 'br',
                'BRA': 'br',
                'Estados Unidos': 'us',
                'United States': 'us',
                'USA': 'us',
                'França': 'fr',
                'France': 'fr',
                'FRA': 'fr',
                'Alemanha': 'de',
                'Germany': 'de',
                'GER': 'de',
                'Rússia': 'ru',
                'Russia': 'ru',
                'RUS': 'ru',
                'China': 'cn',
                'CHN': 'cn',
                'Japão': 'jp',
                'Japan': 'jp',
                'JPN': 'jp',
                'Canadá': 'ca',
                'Canada': 'ca',
                'CAN': 'ca',
                'Austrália': 'au',
                'Australia': 'au',
                'AUS': 'au',
                'Reino Unido': 'gb',
                'United Kingdom': 'gb',
                'GBR': 'gb',
                'Itália': 'it',
                'Italy': 'it',
                'ITA': 'it',
                'Espanha': 'es',
                'Spain': 'es',
                'ESP': 'es',
                'Holanda': 'nl',
                'Netherlands': 'nl',
                'NED': 'nl',
                'Bélgica': 'be',
                'Belgium': 'be',
                'BEL': 'be',
                'Romênia': 'ro',
                'Romania': 'ro',
                'ROU': 'ro',
                'Ucrânia': 'ua',
                'Ukraine': 'ua',
                'UKR': 'ua'
            };
            return codes[country] || 'xx';
        }

        // Tornar função global para o botão
        window.loadResults = loadResults;

        // Aguardar Firebase estar pronto
        function initializeWhenReady() {
            if (window.db) {
                loadResults();
            } else {
                setTimeout(initializeWhenReady, 100);
            }
        }
        
        // Inicializar quando DOM estiver pronto
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeWhenReady);
        } else {
            initializeWhenReady();
        }
    </script>
</body>
</html>
